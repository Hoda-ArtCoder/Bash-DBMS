#!/bin/bash
source ./Validations
source ./Common

function updateTable() {
    read -p "Enter the name of the table you want to update: " table_name

    table_file="$DB_DIR/$SELECTED_DB/$table_name"
    metadata_file="$DB_DIR/$SELECTED_DB/$table_name.metadata"

    if [[ ! -f "$table_file" ]]; then
        echo -e "${yellow}Warrning: Table '$table_name' does not exist.${clear}"
        tablesMenu
    fi

    if [[ ! -f "$metadata_file" ]]; then
        echo -e "${yellow}Warrning: Metadata file for '$table_name' not found.${clear}"
        tablesMenu
    fi

    # Display table columns
    echo -e "${cyan}Available columns:${clear}"
    awk -F':' '{print NR ". " $1}' "$metadata_file"

    # Prompt for column to filter records
    read -p "Enter the column name to filter by: " filter_column

    # Find the column index in metadata
    filter_col_index=$(grep -n "^$filter_column:" "$metadata_file" | cut -d: -f1)

    if [[ -z "$filter_col_index" ]]; then
        echo -e "${red}Warning: Column '$filter_column' does not exist.${clear}"
        return
    fi

    # Prompt for the value to search for
    read -p "Enter the value to filter records: " filter_value

    # Prompt for the column to update
    read -p "Enter the column name to update: " update_column

    # Find the update column index in metadata
    update_col_index=$(grep -n "^$update_column:" "$metadata_file" | cut -d: -f1)

    if [[ -z "$update_col_index" ]]; then
        echo -e "${yellow}Warning: Column '$update_column' does not exist.${clear}"
        return
    fi

    # Prompt for the new value
    read -p "Enter the new value for '$update_column': " new_value

    # Update the table using awk
    awk -F':' -v filter_col="$filter_col_index" -v filter_val="$filter_value" \
        -v update_col="$update_col_index" -v new_val="$new_value" \
        'BEGIN {OFS=FS} 
        NR == 1 || $filter_col != filter_val {print $0; next} 
        { $update_col = new_val; print $0 }' "$table_file" > tmp && mv tmp "$table_file"

    echo -e "${green}Update successful!${clear}"
}
